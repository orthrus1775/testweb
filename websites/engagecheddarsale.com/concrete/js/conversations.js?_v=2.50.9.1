/*! the-hive */
!function(b,_){"use strict";b.extend(b.fn,{concreteConversation:function(t){return this.each(function(){var e=b(this);e.data("concreteConversation")||e.data("concreteConversation",new n(e,t))})}});var C={Confirm_remove_message:"Remove this message? Replies to it will not be removed.",Confirm_mark_as_spam:"Are you sure you want to flag this message as spam?",Warn_currently_editing:"Please complete or cancel the current message editing session before editing this message.",Unspecified_error_occurred:"An unspecified error occurred.",Error_deleting_message:"Something went wrong while deleting this message, please refresh and try again.",Error_flagging_message:"Something went wrong while flagging this message, please refresh and try again.",Your_comment:"Your comment",Show_new_comments:"Show %d new comments"},n=(b.fn.concreteConversation.localize=function(e){b.extend(!0,C,e)},function(e,t){this.publish("beforeInitializeConversation",{element:e,options:t}),this.init(e,t),this.publish("initializeConversation",{element:e,options:t})});n.fn=n.prototype={publish:function(e,t){(t=t||{}).ConcreteConversation=this,_.ConcreteEvent.publish(e,t)},init:function(e,t){var n=this,e=(n.$element=e,n.options=b.extend({method:"ajax",paginate:!1,displayMode:"threaded",itemsPerPage:-1,activeUsers:[],uID:0,uninitialized:!0,requiresRegistration:!1},t),""!=n.options.posttoken?1:0),t=n.options.disablePosting,o=n.options.paginate?1:0,a=n.options.orderBy,i=n.options.enableOrdering,s=n.options.displayPostingForm,r=n.options.enableCommentRating,c=n.options.commentRatingUserID,l=n.options.commentRatingIP,d=n.options.addMessageLabel||"",m=n.options.dateFormat,p=n.options.customDateFormat,v=n.options.blockAreaHandle,h=(n.options.maxFiles,n.options.maxFileSize,n.options.fileExtensions,n.options.attachmentsEnabled),u=n.options.attachmentOverridesEnabled,g=1==n.options.displayCaptcha?1:0,f=n.options.realtimeMode;"ajax"==n.options.method?b.ajax({type:"POST",url:CCM_TOOLS_PATH+"/conversations/view_ajax",data:{cnvID:n.options.cnvID,cID:n.options.cID,cvID:n.options.cvID,blockID:n.options.blockID,enablePosting:e,disablePosting:t,itemsPerPage:n.options.itemsPerPage,addMessageLabel:d,paginate:o,displayMode:n.options.displayMode,orderBy:a,enableOrdering:i,displayPostingForm:s,enableCommentRating:r,commentRatingUserID:c,commentRatingIP:l,dateFormat:m,customDateFormat:p,blockAreaHandle:v,attachmentsEnabled:h,attachmentOverridesEnabled:u,displayCaptcha:g,realtimeMode:f},headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){var t=_.obj,e=((_.obj=n).$element.empty().append(e),_.location.hash.match(/^#cnv([0-9]+)Message[0-9]+$/));null!==e&&e[1]==n.options.cnvID&&(e=b("a"+_.location.hash).offset(),b("html, body").animate({scrollTop:e.top},800,"linear")),_.obj=t,n.attachBindings(),n.publish("conversationLoaded"),n.$element.find(".redactor-editor").attr("aria-label",C.Your_comment),b(_).on("signedin.hive",function(e){n.$element.find(".js-alert-registered-only").hide().attr("aria-hidden","true"),n.$element.find(".js-alert-error").empty().hide().attr("aria-hidden","true"),n.$element.find("form").show().attr("aria-hidden","false"),n.fillUserAttributeFields(e.attributes),n.$element.find(".js-show-guest").hide().attr("aria-hidden","true"),e.add_conversation_message_token&&(n.options.posttoken=e.add_conversation_message_token),e.add_conversations_file_token&&n.$element.find('.ccm-conversation-attachment-container [name="ccm_token"]').val(e.add_conversations_file_token),void 0!==e.uID&&(n.options.uID=parseInt(e.uID))}),b(_).on("signedout.hive",function(e){n.options.requiresRegistration&&(n.$element.find(".js-alert-registered-only").show().attr("aria-hidden","false"),n.$element.find("form").hide().attr("aria-hidden","true")),n.$element.find(".js-show-guest").show().attr("aria-hidden","false"),void 0!==e.tokens&&(void 0!==e.tokens.add_conversation_message_token&&(n.options.posttoken=e.tokens.add_conversation_message_token),void 0!==e.tokens.add_conversations_file_token)&&n.$element.find('.ccm-conversation-attachment-container [name="ccm_token"]').val(e.tokens.add_conversations_file_token),n.options.uID=0}),n.lastLoaded=(new Date).toISOString(),n.messagesSinceLastLoad=0,n.newMessages=0}}):(n.attachBindings(),n.finishSetup(),n.publish("conversationLoaded")),+n.options.realtimeMode&&n.initRealtime()},lastLoaded:null,messagesSinceLastLoad:0,newMessages:0,pollingTime:6e4,initRealtime:function(){var e=this;setTimeout(e.poll.bind(e),e.pollingTime)},poll:function(){var n=this,o=Math.max(n.messagesSinceLastLoad-n.newMessages,0);n.checkNewMessages().then(function(){var e=n.$realtimePanel.find("button.ccm-conversation-realtime"),t=Math.max(n.messagesSinceLastLoad-n.newMessages,0),e=(0<t&&e.show().text(C.Show_new_comments.replace("%d",t)).off("click").on("click",function(){b(this).hide().text(""),b("html, body").animate({scrollTop:n.$messagelist.offset().top},800,"linear"),n.reloadMessages()}),t-o),t=0<e?n.pollingTime/e:0;n.pollingTime=0<t&&t<=6e4?Math.max(n.pollingTime/2,6e4):Math.min(2*n.pollingTime,24e4),setTimeout(n.poll.bind(n),n.pollingTime)})},checkNewMessages:function(){var t=this;return b.ajax({type:"POST",url:CCM_DISPATCHER_FILENAME+"/ccm/the_hive_feedback/core_conversation/check_messages",data:{cnvID:t.options.cnvID,since:t.lastLoaded},headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){void 0!==e.count&&(t.messagesSinceLastLoad=e.count)}})},reloadMessages:function(t){var n=this;n.$replyholder.appendTo(n.$element),n.$replyholder.hide(),n.$replyholder.find(".conversation-editor").val("");try{n.$replyholder.find(".redactor_conversation_editor_"+n.options.cnvID).redactor("set","")}catch(e){}n.$messagelist.load(CCM_TOOLS_PATH+"/conversations/view_ajax",{cnvID:n.options.cnvID,task:"get_messages",cID:n.options.cID,cvID:n.options.cvID,blockID:n.options.blockID,enablePosting:""!=n.options.posttoken?1:0,disablePosting:n.options.disablePosting,displayMode:n.options.displayMode,itemsPerPage:n.options.itemsPerPage,paginate:n.options.paginate?1:0,addMessageLabel:n.options.addMessageLabel||"",orderBy:n.options.orderBy,enableOrdering:n.options.enableOrdering,displayPostingForm:n.options.displayPostingForm,enableCommentRating:n.options.enableCommentRating,dateFormat:n.options.dateFormat,customDateFormat:n.options.customDateFormat,blockAreaHandle:n.options.blockAreaHandle,attachmentsEnabled:n.options.attachmentsEnabled,attachmentOverridesEnabled:n.options.attachmentOverridesEnabled,displayCaptcha:n.options.displayCaptcha,realtimeMode:n.options.realtimeMode},function(e){b(".ccm-conversation-messages .dropdown-toggle").dropdown(),n.attachBindings(),n.lastLoaded=(new Date).toISOString(),n.messagesSinceLastLoad=0,n.newMessages=0,"function"==typeof t&&t()})},mentionList:function(e,t,n){var o=this;t&&(o.dropdown.parent.css({top:t.y,left:t.x}),0==e.length?(o.dropdown.handle.dropdown("toggle"),o.dropdown.parent.remove(),o.dropdown.active=!1,o.dropdown.activeItem=-1):(o.dropdown.list.empty(),e.slice(0,20).map(function(e){var t=b("<li/>");b("<a/>").appendTo(t).text(e.getName()).click(function(){ConcreteEvent.fire("ConversationMentionSelect",{obj:o,item:e},n)}),t.appendTo(o.dropdown.list)}),o.dropdown.active||(o.dropdown.active=!0,o.dropdown.activeItem=-1,o.dropdown.parent.appendTo(o.$element),o.dropdown.handle.dropdown("toggle")),0<=o.dropdown.activeItem&&o.dropdown.list.children().eq(o.dropdown.activeItem).addClass("active")))},attachSubscriptionBindings:function(){b("a[data-conversation-subscribe]").magnificPopup({type:"ajax",callbacks:{updateStatus:function(e){var t;"ready"==e.status&&(t=b("form[data-conversation-form=subscribe]"),b("button").on("click",t,function(e){e.preventDefault(),e.stopPropagation(),b.ajax({url:t.attr("action"),dataType:"json",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){(e.subscribed?(b("[data-conversation-subscribe=subscribe]").hide(),b("[data-conversation-subscribe=unsubscribe]")):(b("[data-conversation-subscribe=unsubscribe]").hide(),b("[data-conversation-subscribe=subscribe]"))).show(),b.magnificPopup.close()}})}))},beforeOpen:function(){this.st.mainClass="mfp-zoom-in"}},closeOnContentClick:!0,midClick:!0})},attachBindings:function(){var o=this,a=(o.$element.off(".cnv"),o.options.uninitialized&&(o.options.uninitialized=!1,ConcreteEvent.bind("ConversationMention",function(e,t){o.mentionList(t.items,t.coordinates||!1,t.bindTo||o.$element.get(0))},o.$element.get(0)),o.dropdown={},o.dropdown.parent=b("<div/>").css({position:"absolute",height:0,width:0}),o.dropdown.active=!1,o.dropdown.handle=b("<a/>").appendTo(o.dropdown.parent),o.dropdown.list=b("<ul/>").addClass("dropdown-menu").appendTo(o.dropdown.parent),o.dropdown.handle.dropdown(),ConcreteEvent.bind("ConversationTextareaKeydownUp",function(e){-1==o.dropdown.activeItem&&(o.dropdown.activeItem=o.dropdown.list.children().length),--o.dropdown.activeItem,o.dropdown.activeItem+=o.dropdown.list.children().length,o.dropdown.activeItem%=o.dropdown.list.children().length,o.dropdown.list.children().filter(".active").removeClass("active").end().eq(o.dropdown.activeItem).addClass("active")},o.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownDown",function(e){o.dropdown.activeItem+=1,o.dropdown.activeItem+=o.dropdown.list.children().length,o.dropdown.activeItem%=o.dropdown.list.children().length,o.dropdown.list.children().filter(".active").removeClass("active").end().eq(o.dropdown.activeItem).addClass("active")},o.$element.get(0)),ConcreteEvent.bind("ConversationTextareaKeydownEnter",function(e){o.dropdown.list.children().filter(".active").children("a").click()},o.$element.get(0)),ConcreteEvent.bind("ConversationPostError",function(e,t){var n=t.form,t=t.messages,o="";b.each(t,function(e,t){o+="<div>"+t+"</div>"}),n.find("div.ccm-conversation-errors").html(o).show()}),ConcreteEvent.bind("ConversationGeneralError",function(e,t){var n=t.form,t=t.messages,o="";b.each(t,function(e,t){o+="<div>"+t+"</div>"}),n.parent().find(".js-alert-error").html(o).show().attr("aria-hidden","false")}),ConcreteEvent.bind("ConversationBeforeSubmitForm",function(e,t){t.form.find("div.ccm-conversation-errors").empty().hide().attr("aria-hidden","true"),t.form.parent().find(".js-alert-error").empty().hide().attr("aria-hidden","true")})),o.options.paginate,""!=o.options.posttoken?1:0),i=o.options.addMessageLabel||"",t=(o.$replyholder=o.$element.find("div.ccm-conversation-add-reply"),o.$newmessageholder=o.$element.find("div.ccm-conversation-add-new-message"),o.$newmessageform=o.$element.find("div.ccm-conversation-add-new-message form"),o.$deleteholder=o.$element.find("div.ccm-conversation-delete-message"),o.$attachmentdeleteholder=o.$element.find("div.ccm-conversation-delete-attachment"),o.$permalinkholder=o.$element.find("div.ccm-conversation-message-permalink"),o.$messagelist=o.$element.find("div.ccm-conversation-message-list"),o.$messagecnt=o.$element.find(".ccm-conversation-message-count"),o.$postbuttons=o.$element.find("[data-submit=conversation-message]"),o.$sortselect=o.$element.find("select[data-sort=conversation-message-list]"),o.$loadmore=o.$element.find("[data-load-page=conversation-message-list]"),o.$messages=o.$element.find("div.ccm-conversation-messages"),o.$messagerating=o.$element.find("span.ccm-conversation-message-rating"),+o.options.realtimeMode&&(o.$realtimePanel=o.$element.find("div.realtime-button-panel"),o.$realtimePanel.scrollToFixed({marginTop:b("#ccm-toolbar").length?80:15,limit:function(){return o.$messagelist.offset().top+o.$element.outerHeight()-o.$realtimePanel.outerHeight()},removeOffsets:!0})),o.$newmessageform.validate({ignore:":hidden:not([name=cnvMessageBody]), [contenteditable='true']:not([name])",rules:{cnvMessageBody:"required"},messages:{privacy_consent:o.options.privacyErrorMessage},highlight:function(e){(b(e).parent(".redactor-box").length?b(e).closest(".ccm-conversation-message-form"):b(e).closest(".form-group")).addClass("has-error")},unhighlight:function(e){(b(e).parent(".redactor-box").length?b(e).closest(".ccm-conversation-message-form"):b(e).closest(".form-group")).removeClass("has-error")},errorElement:"span",errorClass:"help-block help-validation",errorPlacement:function(e,t){t.closest(".radioList, .checkboxList").length?e.appendTo(t.closest(".radioList, .checkboxList")):t.parent(".input-group, label, .checkbox").length?e.insertAfter(t.parent()):e.insertAfter(t)},invalidHandler:function(e,t){(b(t.errorList[0].element).parent(".redactor-box").length?b(t.errorList[0].element).prev():t.errorList[0].element).focus()}}),o.$element.on("click.cnv","[data-submit=conversation-message]",function(e){e.preventDefault(),o.submitForm(b(this))}),o.$element.on("click.cnv","[data-submit=update-conversation-message]",function(){return o.submitUpdateForm(b(this)),!1}),this.attachSubscriptionBindings(),1);o.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(e){e.preventDefault(),b(".ccm-conversation-attachment-container").each(function(){var e=b(this);e.is(":visible")&&e.toggle(),b('[aria-controls="'+e.get(0).id+'"]').attr("aria-expanded",e.is(":visible"))});e=o.$replyholder.appendTo(b(this).closest("div[data-conversation-message-id]"));return e.attr("data-form","conversation-reply").show(),e.find("[data-submit=conversation-message]").attr("data-post-parent-id",b(this).attr("data-post-parent-id")),e.attr("rel","new-reply"+t),t++,e.find("form").validate({ignore:":hidden:not([name=cnvMessageBody]), [contenteditable='true']:not([name])",rules:{cnvMessageBody:"required"},messages:{privacy_consent:o.options.privacyErrorMessage},highlight:function(e){(b(e).parent(".redactor-box").length?b(e).closest(".ccm-conversation-message-form"):b(e).closest(".form-group")).addClass("has-error")},unhighlight:function(e){(b(e).parent(".redactor-box").length?b(e).closest(".ccm-conversation-message-form"):b(e).closest(".form-group")).removeClass("has-error")},errorElement:"span",errorClass:"help-block help-validation",errorPlacement:function(e,t){t.closest(".radioList, .checkboxList").length?e.appendTo(t.closest(".radioList, .checkboxList")):t.parent(".input-group, label, .checkbox").length?e.insertAfter(t.parent()):e.insertAfter(t)}}),"undefined"!=typeof onLoadRecaptchaCallback&&onLoadRecaptchaCallback(),!1}),b(".ccm-conversation-attachment-container").hide(),o.$newmessageform.find(".ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(e){e.preventDefault();e=o.$replyholder.find(".ccm-conversation-attachment-container"),e.is(":visible")&&(e.toggle(),b('[aria-controls="'+e.get(0).id+'"]').attr("aria-expanded",!1)),e=o.$newmessageholder.find(".ccm-conversation-attachment-container");e.toggle(),b(this).attr("aria-expanded",e.is(":visible")),e.is(":visible")&&e.find("form").focus()}),b(".ccm-conversation-add-reply .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(e){e.preventDefault();e=o.$newmessageholder.find(".ccm-conversation-attachment-container"),e.is(":visible")&&(e.toggle(),b('[aria-controls="'+e.get(0).id+'"]').attr("aria-expanded",!1)),e=o.$replyholder.find(".ccm-conversation-attachment-container");e.toggle(),b(this).attr("aria-expanded",e.is(":visible")),e.is(":visible")&&e.find("form").focus()}),o.$element.on("click.cnv","a[data-submit=delete-conversation-message]",function(){var e=b(this);return o.$deletedialog=o.$deleteholder.clone(),o.$deletedialog.dialog?o.$deletedialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:o.$deleteholder.attr("data-dialog-title"),buttons:[{text:o.$deleteholder.attr("data-cancel-button-title"),class:"btn pull-left",click:function(){o.$deletedialog.dialog("close")}},{text:o.$deleteholder.attr("data-confirm-button-title"),class:"btn pull-right btn-danger",click:function(){o.deleteMessage(e.attr("data-conversation-message-id"))}}]}):_.confirm(C.Confirm_remove_message)&&o.deleteMessage(e.attr("data-conversation-message-id")),!1}),o.$element.on("click.cnv","a[data-submit=flag-conversation-message]",function(){var e=b(this);return _.confirm(C.Confirm_mark_as_spam)&&o.flagMessage(e.attr("data-conversation-message-id")),!1}),o.$element.on("click.cnv","a[data-load=edit-conversation-message]",function(){if(b(".ccm-conversation-edit-message").is(":visible"))return _.alert(C.Warn_currently_editing),!1;var e=b(this);o.editMessage(e.attr("data-conversation-message-id"))}),o.$element.on("change.cnv","select[data-sort=conversation-message-list]",function(){o.options.orderBy=b(this).val(),o.reloadMessages(function(){o.$sortselect.focus()})}),o.$element.on("click.cnv",".image-popover-hover",function(){b.magnificPopup.open({items:{src:b(this).attr("data-full-image"),type:"image",verticalFit:!0}})}),o.$element.on("click.cnv","[data-load-page=conversation-message-list]",function(){var t=parseInt(o.$loadmore.attr("data-next-page")),n=parseInt(o.$loadmore.attr("data-total-pages")),e={cnvID:o.options.cnvID,cID:o.options.cID,cvID:o.options.cvID,blockID:o.options.blockID,itemsPerPage:o.options.itemsPerPage,displayMode:o.options.displayMode,blockAreaHandle:o.options.blockAreaHandle,enablePosting:a,disablePosting:o.options.disablePosting,addMessageLabel:i,page:t,orderBy:o.options.orderBy,enableCommentRating:o.options.enableCommentRating,dateFormat:o.options.dateFormat,customDateFormat:o.options.customDateFormat,attachmentsEnabled:o.options.attachmentsEnabled,attachmentOverridesEnabled:o.options.attachmentOverridesEnabled};b.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/message_page",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},beforeSend:function(){o.$loadmore.addClass("is-loading")},success:function(e){o.$messages.append(e),b(".ccm-conversation-messages .dropdown-toggle").dropdown(),n<t+1?o.$loadmore.hide().attr("aria-hidden",!0):o.$loadmore.attr("data-next-page",t+1)},complete:function(){o.$loadmore.removeClass("is-loading")}})}),o.$element.on("click.cnv",".conversation-rate-message",function(){var t=b(this).closest("[data-conversation-message-id]").attr("data-conversation-message-id"),e=b(this).attr("data-conversation-rating-type"),e=(o.$messagerating.load(CCM_TOOLS_PATH+"/conversations/rate"),{cnvID:o.options.cnvID,cID:o.options.cID,cvID:o.options.cvID,blockID:o.options.blockID,cnvMessageID:t,cnvRatingTypeHandle:e,commentRatingUserID:o.options.commentRatingUserID,commentRatingIP:o.options.commentRatingIP});b.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/rate",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){b('span[data-message-rating="'+t+'"]').load(CCM_TOOLS_PATH+"/conversations/get_rating",{cnvMessageID:t}),_paq.push(["trackEvent","core_conversation","rate",o.options.bID])}})}),o.$element.on("click.cnv","a.share-popup",function(){var e=null!=_.screenLeft?_.screenLeft:screen.left,t=null!=_.screenTop?_.screenTop:screen.top,e=(_.innerWidth||document.documentElement.clientWidth||screen.width)/2-300+e,t=(_.innerHeight||document.documentElement.clientHeight||screen.height)/2-125+t;return _.open(b(this).attr("href"),"cnvSocialShare","left:"+e+",top:"+t+",height=250,width=600,toolbar=no,status=no"),!1}),o.$element.on("click.cnv","a.share-permalink",function(){var e=b(this).attr("rel"),e=(o.$permalinkdialog=o.$permalinkholder.clone(),b("<textarea readonly>").text(decodeURIComponent(e)));return o.$permalinkdialog.append(e),e.click(function(){var e=b(this);e.select(),_.setTimeout(function(){e.select()},1),e.mouseup(function(){return e.off("mouseup"),!1})}),o.$permalinkdialog.dialog&&o.$permalinkdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:o.$permalinkholder.attr("data-dialog-title"),buttons:[{text:o.$permalinkholder.attr("data-cancel-button-title"),class:"btn pull-left",click:function(){o.$permalinkdialog.dialog("close")}}]}),!1}),0<o.options.attachmentsEnabled&&o.$element.concreteConversationAttachments(o),b(".dropdown-toggle").dropdown(),o.$element.find(".ccm-conversation-attachment-toggle").on("keydown",function(e){9!==e.which||e.shiftKey||o.$element.find(".ccm-conversation-attachment-container").is(":visible")&&(e.preventDefault(),o.$element.find(".ccm-conversation-attachment-container form").focus())}),o.$element.find(".ccm-conversation-attachment-container form").on("keydown",function(e){var t=b(this).closest(".ccm-conversation-add-new-message, .ccm-conversation-add-reply");if(9===e.which)e.preventDefault(),(e.shiftKey?t.find(".ccm-conversation-attachment-toggle"):t.find('[data-submit="conversation-message"]')).focus();else if(13===e.which||32===e.which)return e.preventDefault(),b(this).data("dropzone").hiddenFileInput.click()}),o.$postbuttons.on("keydown",function(e){var t=b(this).closest(".ccm-conversation-add-new-message, .ccm-conversation-add-reply");9===e.which&&e.shiftKey&&t.find(".ccm-conversation-attachment-container").is(":visible")&&(e.preventDefault(),t.find(".ccm-conversation-attachment-container form").focus())}),o.$element.find("form").on("grecaptcha.callback",function(n){b.each(b("[data-conversation-id="+o.options.cnvID+"]").find("form").not(".dropzone"),function(e,t){if(b(t).find(".grecaptcha-invisible").attr("id")==n.el_id)return o.submitForm(b(t).find("[type=submit]")),!1})})},handlePostError:function(e,t){t=t||[C.Unspecified_error_occurred],this.publish("conversationPostError",{form:e,messages:t})},handleSessionExpiredError:function(e,t){var n={sessionExpired:!0,tokens:t.tokens};this.publish("ConversationGeneralError",{form:e,messages:t.errors}),b(_).trigger(b.Event("signedout.hive",n))},deleteMessage:function(n){var o=this;o.publish("conversationBeforeDeleteMessage",{msgID:n}),b.ajax({type:"post",data:[{name:"cnvMessageID",value:n}],url:CCM_TOOLS_PATH+"/conversations/delete_message",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){var t=b("div[data-conversation-message-id="+n+"]");t.length&&t.after(e).remove(),o.updateCount(),o.$deletedialog.dialog&&o.$deletedialog.dialog("close"),o.publish("conversationDeleteMessage",{msgID:n})},error:function(e){o.publish("conversationDeleteMessageError",{msgID:n,error:arguments}),_.alert(C.Error_deleting_message)}})},editMessage:function(o){var a=this,e=[{name:"cnvMessageID",value:o},{name:"cID",value:this.options.cID},{name:"cvID",value:this.options.cvID},{name:"blockAreaHandle",value:this.options.blockAreaHandle},{name:"bID",value:this.options.blockID}];b.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/edit_message",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){var t=b("div[data-conversation-message-id="+o+"]"),n=t;t.after(e).remove(),b(".ccm-conversation-attachment-container").hide(),b(".ccm-conversation-edit-message .ccm-conversation-attachment-toggle").off("click.cnv").on("click.cnv",function(e){e.preventDefault(),b(".ccm-conversation-edit-message .ccm-conversation-attachment-container").toggle()}),a.$editMessageHolder=a.$element.find("div.ccm-conversation-edit-message"),a.$element.concreteConversationAttachments(a),b("button.cancel-update").on("click.cnv",function(){b(".ccm-conversation-edit-message").replaceWith(n)})},error:function(e){a.publish("conversationEditMessageError",{msgID:o,error:arguments})}})},flagMessage:function(n){var o=this;o.publish("conversationBeforeFlagMessage",{msgID:n}),b.ajax({type:"post",data:[{name:"cnvMessageID",value:n}],url:CCM_TOOLS_PATH+"/conversations/flag_message",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){var t=b("div[data-conversation-message-id="+n+"]");t.length&&t.after(e).remove(),o.updateCount(),o.publish("conversationFlagMessage",{msgID:n})},error:function(e){o.publish("conversationFlagMessageError",{msgID:n,error:arguments}),_.alert(C.Error_flagging_message)}})},addMessageFromJSON:function(n,o){var a=this,e=(a.publish("conversationBeforeAddMessageFromJSON",{json:o,form:n}),""!=a.options.posttoken?1:0),e=[{name:"cnvMessageID",value:o.cnvMessageID},{name:"enablePosting",value:e},{name:"displayMode",value:a.options.displayMode},{name:"enableCommentRating",value:a.options.enableCommentRating}];b.ajax({type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/message_detail",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){var t=b("div[data-conversation-message-id="+o.cnvMessageParentID+"]");if(t.length){t.after(e),a.$replyholder.appendTo(a.$element),a.$replyholder.hide(),a.$replyholder.find(".conversation-editor").val("");try{a.$replyholder.find(".redactor_conversation_editor_"+a.options.cnvID).redactor("set","")}catch(e){}}else{"date_desc"==a.options.orderBy?a.$messages.prepend(e):a.$messages.append(e),a.$element.find(".ccm-conversation-no-messages").hide(),a.$newmessageform.find(".conversation-editor").val("");try{a.$newmessageform.find(".redactor_conversation_editor_"+a.options.cnvID).redactor("set","")}catch(e){}}a.publish("conversationAddMessageFromJSON",{json:o,form:n}),a.updateCount();t=b("a#cnv"+a.options.cnvID+"Message"+o.cnvMessageID).offset();b(".dropdown-toggle").dropdown(),b("html, body").animate({scrollTop:t.top},800,"linear")}})},updateMessageFromJSON:function(e,t){var n=""!=this.options.posttoken?1:0,n=[{name:"cnvMessageID",value:t.cnvMessageID},{name:"enablePosting",value:n},{name:"displayMode",value:this.options.displayMode},{name:"enableCommentRating",value:this.options.enableCommentRating}];b.ajax({type:"post",data:n,url:CCM_TOOLS_PATH+"/conversations/message_detail",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){b("div[data-conversation-message-id="+t.cnvMessageID+"]").after(e).remove(),b(".dropdown-toggle").dropdown()}})},updateCount:function(){var t=this;t.publish("conversationBeforeUpdateCount"),b.ajax({type:"POST",url:CCM_TOOLS_PATH+"/conversations/count_header",data:{cnvID:t.options.cnvID},headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){t.$messagecnt.html(b(e).html()),t.publish("conversationUpdateCount")}})},submitForm:function(t){var n,e,o,a=t.closest("form");return!("undefined"!=typeof HiveAntiSpam&&!HiveAntiSpam.evaluateRequest(a)||!a.valid())&&((n=this).publish("conversationBeforeSubmitForm",{form:a}),t.prop("disabled",!0),a.find(".loader").show(),a.parent().addClass("ccm-conversation-form-submitted"),e=a.serializeArray(),o=t.attr("data-post-parent-id"),e.push({name:"token",value:n.options.posttoken},{name:"cnvID",value:n.options.cnvID},{name:"cnvMessageParentID",value:o},{name:"enableRating",value:o},{name:"uID",value:n.options.uID}),void b.ajax({dataType:"json",type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/add_message",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){return e?e.sessionExpired?(n.handleSessionExpiredError(a,e),!1):e.error?(n.handlePostError(a,e.errors),!1):(b(".preview.processing").each(function(){b('input[rel="'+b(this).attr("rel")+'"]').remove()}),b("form.dropzone").each(function(){var n=b(this).data("dropzone");b.each(n.files,function(e,t){n.removeFile(t)})}),n.newMessages++,n.resetForm(a),n.addMessageFromJSON(a,e),n.publish("conversationSubmitForm",{form:a,response:e}),_paq.push(["trackEvent","core_conversation","submit",n.options.bID]),void b(_).trigger(b.Event("feedback.hive",{bID:n.options.blockID}))):(n.handlePostError(a),!1)},error:function(e){return n.handlePostError(a),!1},complete:function(e){t.prop("disabled",!1),a.find(".loader").hide(),a.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted"),"undefined"!=typeof HiveAntiSpam&&HiveAntiSpam.reset(a)}}))},submitUpdateForm:function(t){var n=this,o=t.closest("form"),e=(n.publish("conversationBeforeSubmitForm",{form:o}),t.prop("disabled",!0),o.find(".loader").show(),o.parent().addClass("ccm-conversation-form-submitted"),o.serializeArray()),a=t.attr("data-post-message-id");e.push({name:"token",value:n.options.posttoken},{name:"cnvMessageID",value:a}),b.ajax({dataType:"json",type:"post",data:e,url:CCM_TOOLS_PATH+"/conversations/update_message",headers:{"X-Locale":_.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){return e?e.error?(n.handlePostError(o,e.errors),!1):(b(".preview.processing").each(function(){b('input[rel="'+b(this).attr("rel")+'"]').remove()}),n.updateMessageFromJSON(o,e),void n.publish("conversationSubmitForm",{form:o,response:e})):(n.handlePostError(o),!1)},error:function(e){return n.handlePostError(o),!1},complete:function(e){t.prop("disabled",!1),o.find(".loader").hide(),o.parent().closest(".ccm-conversation-form-submitted").removeClass("ccm-conversation-form-submitted")}})},fillUserAttributeFields:function(o){this.$element.find('[name^="akID["]').each(function(e,t){var t=b(t),n=t.attr("name"),n=n.substring(n.search(/\[/)+1,n.search(/\]/));void 0!==o[n]&&t.val(o[n])})},resetForm:function(e){e.find(".redactor-editor").html("")},tool:{setCaretPosition:function(e,t){var n;null!=e&&(e.createTextRange?((n=e.createTextRange()).move("character",t),n.select()):e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus())},getCaretPosition:function(e){var t,n;return e.selectionStart||(!document.selection||(e.focus(),null==(t=document.selection.createRange()))?0:(n=(e=e.createTextRange()).duplicate(),e.moveToBookmark(t.getBookmark()),n.setEndPoint("EndToStart",e),n.text.length))},testMentionString:function(e){return/^@[a-z0-9]+$/.test(e)},getMentionMatches:function(t,e){return e.filter(function(e){return 0<=e.indexOf(t)})},isSameConversation:function(e,t){return e.options.blockID===t.options.blockID&&e.options.cnvID===t.options.cnvID},MentionUser:function(e){this.getName=function(){return e}}}}}(jQuery,window),function(i,a){var s={Drop_files_or_click_to_upload:"Drop files here or click to upload",Too_many_files:"Too many files",Invalid_file_extension:"Invalid file extension",Max_file_size_exceeded:"Max file size exceeded",Error_deleting_attachment:"Something went wrong while deleting this attachment, please refresh and try again.",Confirm_remove_attachment:"Remove this attachment?"},t={init:function(e){var a=e;return a.$element.on("click.cnv","a[data-toggle=conversation-reply]",function(){i(".ccm-conversation-wrapper").concreteConversationAttachments("clearDropzoneQueues")}),a.$element.on("click.cnv","a.attachment-delete",function(e){e.preventDefault(),i(this).concreteConversationAttachments("attachmentDeleteTrigger",a)}),a.$editMessageHolder&&!a.$editMessageHolder.find(".dropzone").attr("data-dropzone-applied")&&a.$editMessageHolder.find(".dropzone").not('[data-dropzone-applied="true"]').dropzone({dictDefaultMessage:s.Drop_files_or_click_to_upload,url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(e,t){var n=this,t=(i(e.previewTemplate).click(function(){n.removeFile(e),i('input[rel="'+i(this).attr("rel")+'"]').remove()}),JSON.parse(t)),o=i(e.previewTemplate).closest(".ccm-conversation-attachment-container").prev("form");o.find("[data-submit]").prop("disabled",!1),o.find(".loader").hide(),t.error?(o=i('.preview.processing[rel="'+t.timestamp+'"]').closest("form"),a.handlePostError(o,[t.error]),i('.preview.processing[rel="'+t.timestamp+'"]').remove(),o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){i(this).html("")})):i(this.element).closest("div.ccm-conversation-edit-message").find("form.aux-reply-form").append('<input rel="'+t.timestamp+'" type="hidden" name="attachments[]" value="'+t.id+'" />')},accept:function(e,t){var n=[],o=this.files.length,o=(0<a.options.maxFiles&&o>a.options.maxFiles&&n.push(s.Too_many_files),a.options.fileExtensions.split(","));e.name.split(".").pop().toLowerCase()&&-1==o.indexOf(e.name.split(".").pop().toLowerCase())&&""!=o&&n.push(s.Invalid_file_extension),0<a.options.maxFileSize&&e.size>1e6*a.options.maxFileSize&&n.push(s.Max_file_size_exceeded),0<n.length?(i('input[rel="'+i(e.previewTemplate).attr("rel")+'"]').remove(),o=i(e.previewTemplate).parent(".dropzone"),this.removeFile(e),a.handlePostError(o,n),o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){i(this).html("")}),t("error")):((n=i(e.previewTemplate).closest(".ccm-conversation-attachment-container").prev("form")).find("[data-submit]").prop("disabled",!0),n.find(".loader").show(),t())},sending:function(e,t,n){i(e.previewTemplate).attr("rel",(new Date).getTime()),n.append("timestamp",i(e.previewTemplate).attr("rel")),n.append("tag",i(a.$editMessageHOlder).parent("div").attr("rel")),n.append("fileCount",i(a.$editMessageHolder).find('[name="attachments[]"]').length)},init:function(){i(this.element).data("dropzone",this)}}),a.$newmessageform.dropzone&&!i(a.$newmessageform).filter(".dropzone").attr("data-dropzone-applied")&&(a.$newmessageform.filter(".dropzone").dropzone({dictDefaultMessage:s.Drop_files_or_click_to_upload,accept:function(e,t){var n=[],o=this.files.length,o=(0<a.options.maxFiles&&o>a.options.maxFiles&&n.push(s.Too_many_files),a.options.fileExtensions.split(","));e.name.split(".").pop().toLowerCase()&&-1==o.indexOf(e.name.split(".").pop().toLowerCase())&&""!=o&&n.push(s.Invalid_file_extension),0<a.options.maxFileSize&&e.size>1e6*a.options.maxFileSize&&n.push(s.Max_file_size_exceeded),0<n.length?(i('input[rel="'+i(e.previewTemplate).attr("rel")+'"]').remove(),o=i(e.previewTemplate).parent(".dropzone"),this.removeFile(e),a.handlePostError(o,n),o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){i(this).html("")}),t("error")):((n=i(e.previewTemplate).closest(".ccm-conversation-attachment-container").prev("form")).find("[data-submit]").prop("disabled",!0),n.find(".loader").show(),t())},url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(e,t){var n=this,t=(i(e.previewTemplate).click(function(){i('input[rel="'+i(this).attr("rel")+'"]').remove(),n.removeFile(e)}),JSON.parse(t)),o=i(e.previewTemplate).closest(".ccm-conversation-attachment-container").prev("form");o.find("[data-submit]").prop("disabled",!1),o.find(".loader").hide(),t.error?(o=i('.preview.processing[rel="'+t.timestamp+'"]').closest("form"),a.handlePostError(o,[t.error]),i('.preview.processing[rel="'+t.timestamp+'"]').remove(),o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){i(this).html("")})):i('div[rel="'+t.tag+'"] form.main-reply-form').append('<input rel="'+t.timestamp+'" type="hidden" name="attachments[]" value="'+t.id+'" />')},sending:function(e,t,n){i(e.previewTemplate).attr("rel",(new Date).getTime()),n.append("timestamp",i(e.previewTemplate).attr("rel")),n.append("tag",i(a.$newmessageform).parent("div").attr("rel")),n.append("fileCount",this.files.length)},init:function(){i(this.element).data("dropzone",this)}}),i(a.$newmessageform).filter(".dropzone").attr("data-dropzone-applied","true")),i(a.$replyholder.find(".dropzone")).attr("data-dropzone-applied")||a.$replyholder.find(".dropzone").not('[data-dropzone-applied="true"]').dropzone({url:CCM_TOOLS_PATH+"/conversations/add_file",success:function(e,t){var n=this,t=(i(e.previewTemplate).click(function(){n.removeFile(e),i('input[rel="'+i(this).attr("rel")+'"]').remove()}),JSON.parse(t)),o=i(e.previewTemplate).closest(".ccm-conversation-attachment-container").prev("form");o.find("[data-submit]").prop("disabled",!1),o.find(".loader").hide(),t.error?(o=i('.preview.processing[rel="'+t.timestamp+'"]').closest("form"),a.handlePostError(o,[t.error]),i('.preview.processing[rel="'+t.timestamp+'"]').remove(),o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){i(this).html("")})):i(this.element).closest("div.ccm-conversation-add-reply").find("form.aux-reply-form").append('<input rel="'+t.timestamp+'" type="hidden" name="attachments[]" value="'+t.id+'" />')},accept:function(e,t){var n=[],o=this.files.length,o=(0<a.options.maxFiles&&o>a.options.maxFiles&&n.push(s.Too_many_files),a.options.fileExtensions.split(","));e.name.split(".").pop().toLowerCase()&&-1==o.indexOf(e.name.split(".").pop().toLowerCase())&&""!=o&&n.push(s.Invalid_file_extension),0<a.options.maxFileSize&&e.size>1e6*a.options.maxFileSize&&n.push(s.Max_file_size_exceeded),0<n.length?(i('input[rel="'+i(e.previewTemplate).attr("rel")+'"]').remove(),o=i(e.previewTemplate).parent(".dropzone"),this.removeFile(e),a.handlePostError(o,n),o.children(".ccm-conversation-errors").delay(3e3).fadeOut("slow",function(){i(this).html("")}),t("error")):((n=i(e.previewTemplate).closest(".ccm-conversation-attachment-container").prev("form")).find("[data-submit]").prop("disabled",!0),n.find(".loader").show(),t())},sending:function(e,t,n){i(e.previewTemplate).attr("rel",(new Date).getTime()),n.append("timestamp",i(e.previewTemplate).attr("rel")),n.append("tag",i(a.$newmessageform).parent("div").attr("rel")),n.append("fileCount",i(a.$replyHolder).find('[name="attachments[]"]').length)},init:function(){i(this.element).data("dropzone",this)}}),i(a.$replyholder.find(".dropzone")).attr("data-dropzone-applied","true"),i.each(i(this),function(e,t){i(this).find(".ccm-conversation-attachment-container").each(function(){i(this).is(":visible")&&i(this).toggle()})})},attachmentDeleteTrigger:function(e){var t=e,n=i(this);return t.$attachmentdeletetdialog=t.$attachmentdeleteholder.clone(),t.$attachmentdeletetdialog.dialog?t.$attachmentdeletetdialog.dialog({modal:!0,dialogClass:"ccm-conversation-dialog",title:t.$attachmentdeletetdialog.attr("data-dialog-title"),buttons:[{text:t.$attachmentdeleteholder.attr("data-cancel-button-title"),class:"btn pull-left",click:function(){t.$attachmentdeletetdialog.dialog("close")}},{text:t.$attachmentdeleteholder.attr("data-confirm-button-title"),class:"btn pull-right btn-danger",click:function(){i(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:n.attr("rel"),cnvObj:t,dialogObj:t.$attachmentdeletetdialog})}}]}):a.confirm(s.Confirm_remove_attachment)&&i(this).concreteConversationAttachments("deleteAttachment",{cnvMessageAttachmentID:n.attr("rel"),cnvObj:t,dialogObj:t.$attachmentdeletetdialog}),!1},clearDropzoneQueues:function(){i(".preview.processing").each(function(){i('input[rel="'+i(this).attr("rel")+'"]').remove()}),i("form.dropzone").each(function(){var n=i(this).data("dropzone");i.each(n.files,function(e,t){n.removeFile(t)})})},deleteAttachment:function(e){var t=e.cnvMessageAttachmentID,n=e.cnvObj,o=e.dialogObj;i.ajax({type:"post",data:[{name:"cnvMessageAttachmentID",value:t}],url:CCM_TOOLS_PATH+"/conversations/delete_file",headers:{"X-Locale":a.CCM_ACTIVE_LOCALE||"en_US"},success:function(e){e=JSON.parse(e);i('p[rel="'+e.attachmentID+'"]').parent(".attachment-container").fadeOut(300,function(){i(this).remove()}),o.dialog&&(o.dialog("close"),n.publish("conversationDeleteAttachment",{cnvMessageAttachmentID:t}))},error:function(e){n.publish("conversationDeleteAttachmentError",{cnvMessageAttachmentID:t,error:arguments}),a.alert(s.Error_deleting_attachment)}})}};i.fn.concreteConversationAttachments=function(e){return t[e]?t[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?void i.error("Method "+e+" does not exist on concreteConversationAttachments"):t.init.apply(this,arguments)},i.fn.concreteConversationAttachments.localize=function(e){i.extend(!0,s,e)}}(jQuery,window);