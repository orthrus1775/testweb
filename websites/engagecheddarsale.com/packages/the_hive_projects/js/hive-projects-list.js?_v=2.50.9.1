$(function(){
    var bLazy = new Blazy();

    // Load another bunch of projects upon clicking on the Show more button
    $('.projects-list .js-load-more-prj').on('mouseup', function(){
        projectsViewMore($(this).closest('.projects-list'));
    });

    // Added support for keyboard navigation
    $('.projects-list .js-load-more-prj').on('keypress', function(e){
        const KEY_ENTER  = 13;
        const KEY_SPACE  = 32;

        switch (e.keyCode) {
            case KEY_ENTER:
            case KEY_SPACE:
                projectsViewMore($(this).closest('.projects-list'), true);
                break;

            default:
                e.preventDefault();
                break;
        }
    });

    // Reload projects upon login as the user might have permissions to view other projects
    $(window).on('signedin.hive', function() {
        $('.projects-list').each(function(key, item) {
            projectsReload($(item));
        });
    });

    // Revalidate image lazy-loading on project filtering
    $(window).on('searchProjects', function() {
        bLazy.revalidate();
    });

    /**
     * Reload projects in the block
     * @param $block Projects list block
     */
    var projectsReload = function($block) {
        var url = $block.attr('data-route');
        var $loader = $block.find('.loader');

        $block.find('.cards > *').remove(); // remove any current project cards
        $block.find('.alert, .projects-list-bottom').hide();
        $.ajax({
            type: "GET",
            url: url,
            data: {
                page: 0
            },
            dataType: 'json',
            headers: {
                'X-Locale': (window.CCM_ACTIVE_LOCALE || 'en_US')
            },
            beforeSend: function() {
                $block.attr('aria-busy', true);
                $loader.show();
            },
            success: function(ret) {
                var $bottom = $block.find('.projects-list-bottom');
                if (ret.result.length === 0) {
                    $block.find('.alert').show();
                } else {
                    insertProjectCards($block, ret.result);
                    $block.attr('data-page', 1);
                    $block.show();

                    if (!ret.moreToLoad) {
                        $bottom.hide();
                    } else {
                        $bottom.show();
                    }
                }
            },
            complete: function() {
                $loader.hide();
                $block.attr('aria-busy', false);
            }
        });
    };

    /**
     * Load another bunch of projects
     * @param $block Projects list block
     */
    var projectsViewMore = function($block, isKeypress = false) {
        var url = $block.attr('data-route');
        var currentPage = parseInt($block.attr('data-page'));
        $.ajax({
            type: "GET",
            url: url,
            data: {
                page: currentPage
            },
            dataType: 'json',
            headers: {
                'X-Locale': (window.CCM_ACTIVE_LOCALE || 'en_US')
            },
            beforeSend: function() {
                $block.find('.js-load-more-prj').addClass('is-loading').prop('disabled', true);
                $block.attr('aria-busy', true);
            },
            success: function(ret) {
                var $bottom = $block.find('.projects-list-bottom');
                if (ret.result.length === 0) {
                    $bottom.html('<p class="text-center">No more results found.</p>');
                }
                else {
                    insertProjectCards($block, ret.result);
                    $block.attr('data-page', currentPage + 1);

                    if (!ret.moreToLoad) {
                        $bottom.hide();
                    } else {
                        $bottom.show();
                    }
                }
            },
            complete: function(ret) {
                $block.find('.js-load-more-prj').removeClass('is-loading').prop('disabled', false);
                $block.attr('aria-busy', false);

                if (ret.responseJSON.result.length > 0 && isKeypress) {
                    var $cards = $block.children('.cards').children();
                    var $lastCardIndex = $cards.length - ret.responseJSON.result.length;
                    $($cards[$lastCardIndex]).children('a').focus();
                }
            }
        });
    };

    /**
     * Create project cards and append them to the container
     * @param $block Projects list block
     * @param result Projects to be added to the list
     */
    var insertProjectCards = function($block, result) {
        var _templateItem = _.template($('#projectTemplate-' + $block.attr('data-bID')).html());
        var elems = [];
        result.forEach(function(data) {
            var elem = _templateItem(data);
            elems.push(elem);
        });
        $block.find('.cards').append(elems);

        // revalidate lazy-loaded images
        bLazy.revalidate();
    };
});
