$(function() {
    var searchStr = $('.js-projects-filter [name="project-name"]').val(),
        filterCategory = $('.js-projects-filter [name="project-category"]').val(),
        filterLocation = $('.js-projects-filter [name="project-location"]').val()

    var projectNames = []
    var $projects = $('.projects-list [data-project-name]')
    $projects.map(function() {
        projectNames.push($(this).data('project-name'))
    })

    var normalizeSearchStr = function(str) {
        if (typeof str === 'undefined') {
            return '';
        }
        var s = str.toString().toLowerCase();
        s.replace(/[-[\]{}()*+?.,\\^$|#]/g, "\\$&");
        return s;
    };

    var search = function(item, attributeName, searchStr) {
        var attribute = $(item).data(attributeName);
        if (typeof attribute === 'undefined') {
            return false
        }
        var attributeValue = attribute.toString().toLowerCase();
        if (attributeValue.search(searchStr) > -1) {
            return true;
        }
        return false;
    };

    var checkNoFound = function() {
        $.each($('.projects-list'), function(i, val) {
            if ($(val).find('.project[aria-hidden="false"]').length > 0) {
                $(val)
                    .show()
                    .attr('aria-hidden', false)
            } else {
                $(val)
                    .hide()
                    .attr('aria-hidden', true)
            }
        })
        if ($('.projects-list[aria-hidden="false"]').length == 0) {
            $('.hive-block.projects-filter')
                .first()
                .next('.js-no-found')
                .show()
                .attr('aria-hidden', false)
        }
    }

    checkNoFound()

    $('.js-projects-filter').on('searchProjects', function() {
        var nSearchStr = normalizeSearchStr(searchStr)
        var nFilterCategory = normalizeSearchStr(filterCategory)
        var nFilterLocation = normalizeSearchStr(filterLocation)
        $('.projects-list').attr('aria-busy', true)
        $('.hive-block.projects-filter')
            .first()
            .next('.js-no-found')
            .hide()
            .attr('aria-hidden', true)
        // search and filter
        $.each($projects, function(i, val) {
            var found = search(val, 'project-name', nSearchStr)
            var filteredCategory = search(val, 'project-category', nFilterCategory)
            var filteredLocation = search(val, 'project-location', nFilterLocation)
            if (found) {
                $(val)
                    .removeClass('filtered')
                    .show()
                    .attr('aria-hidden', false)
                if (filteredCategory === false || filteredLocation === false) {
                    $(val)
                        .addClass('filtered')
                        .hide()
                        .attr('aria-hidden', true)
                }
            } else {
                $(val)
                    .addClass('filtered')
                    .hide()
                    .attr('aria-hidden', true)
            }
        })
        checkNoFound()
        $('.projects-list').attr('aria-busy', false)
    })

    // autocompleting project name filter field
    $('.js-projects-filter [name="project-name"]').autocomplete({
        select: function(e, ui) {
            searchStr = ui.item.value
            $('.js-projects-filter').trigger('searchProjects')
        },
        source: projectNames,
    })

    $('.js-projects-filter [name="project-name"]').on('keyup input', function(e) {
        searchStr = e.target.value
        $('.js-projects-filter').trigger('searchProjects')
    })
    $('.js-projects-filter [name="project-category"]').on('change', function(e) {
        filterCategory = e.target.value
        $('.js-projects-filter').trigger('searchProjects')
    })
    $('.js-projects-filter [name="project-location"]').on('change', function(e) {
        filterLocation = e.target.value
        $('.js-projects-filter').trigger('searchProjects')
    })

    $('.js-projects-filter').on('submit', function() {
        $(this).trigger('searchProjects')
        return false
    })
})
